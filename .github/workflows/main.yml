name: Story to Video AI Free
on:
  workflow_dispatch:
    inputs:
      story:
        description: 'اكتب قصتك هنا - البوت سيترجمها ويبدأ العمل'
        required: true
        default: 'فضاء يمشي فيه رائد فضاء ببطء'

jobs:
  make-video:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Tools
        run: pip install gradio_client deep-translator

      - name: Generate Video
        run: |
          python - <<EOF
          from gradio_client import Client
          from deep_translator import GoogleTranslator
          import os
          import time

          # 1. الترجمة التلقائية
          try:
              arabic_text = "${{ github.event.inputs.story }}"
              translated = GoogleTranslator(source='auto', target='en').translate(arabic_text)
              print(f"تمت الترجمة إلى: {translated}")
          except:
              translated = "${{ github.event.inputs.story }}"

          # 2. محرك التوليد (استخدام محرك مستقر)
          # سنحاول الاتصال بمحرك CogVideoX-2b الموفر للطاقة
          try:
              print("بدأ الاتصال بالسيرفر... قد يستغرق الأمر دقائق...")
              client = Client("THUDM/CogVideoX-2b-Space")
              result = client.predict(
                  prompt=translated,
                  api_name="/generate"
              )
              
              # تحديد مسار الفيديو الناتج
              video_path = result if isinstance(result, str) else result[0]
              os.rename(video_path, "final_video.mp4")
              print("نجحنا! تم توليد الفيديو.")
          except Exception as e:
              print(f"المحرك مشغول حالياً. الخطأ: {e}")
              with open("sorry.txt", "w") as f:
                  f.write("السيرفرات المجانية مشغولة الآن، يرجى إعادة المحاولة بعد قليل.")
          EOF

      - name: Upload Final Video
        uses: actions/upload-artifact@v4
        with:
          name: AI-Video-Result
          path: |
            final_video.mp4
            sorry.txt
