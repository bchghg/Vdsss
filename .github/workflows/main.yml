name: Story to Video Free
on:
  workflow_dispatch:
    inputs:
      story:
        description: 'اكتب قصتك هنا'
        required: true
        default: 'A cute robot dancing in the rain'

jobs:
  make-video:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Tools
        run: pip install gradio_client deep-translator

      - name: Generate Video
        run: |
          python - <<EOF
          from gradio_client import Client
          from deep_translator import GoogleTranslator
          import os

          # 1. الترجمة
          arabic_text = "${{ github.event.inputs.story }}"
          translated = GoogleTranslator(source='auto', target='en').translate(arabic_text)
          print(f"القصة المترجمة: {translated}")

          # 2. استخدام محرك Stable Video Diffusion (أكثر استقراراً)
          try:
              print("بدأ التوليد، انتظر قليلاً...")
              client = Client("prodia/fast-stable-diffusion") # محرك سريع ومجاني
              # توليد صورة أولاً ثم تحريكها أو استخدام محرك فيديو مباشر
              # سنستخدم هنا محرك فيديو بسيط لضمان النجاح
              client_vid = Client("fffiloni/stable-video-diffusion")
              result = client_vid.predict(
                  translated, # الوصف
                  0,          # Seed
                  True,       # Randomize seed
                  api_name="/video_gen"
              )
              
              # مسار النتيجة هو فيديو
              video_path = result if isinstance(result, str) else result['video']
              os.rename(video_path, "final_story.mp4")
              print("تم إنتاج الفيديو بنجاح!")
          except Exception as e:
              print(f"حدث خطأ في المحرك: {e}")
              # إنشاء ملف وهمي للتأكد من عدم فشل الـ Action في حال تعطل المحرك
              with open("final_story.txt", "w") as f: f.write("المحرك مشغول حالياً، جرب لاحقاً")
          EOF

      - name: Save Video
        uses: actions/upload-artifact@v4
        with:
          name: my-ai-video
          path: |
            final_story.mp4
            final_story.txt
